---
- name: Ensure opengist group exists
  group:
    name: "{{ opengist_group }}"

- name: Ensure opengist user exists
  user:
    name: "{{ opengist_user }}"
    group: "{{ opengist_group }}"
    shell: /usr/sbin/nologin
    home: /var/lib/opengist

- name: Create Opengist directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ opengist_user }}"
    group: "{{ opengist_group }}"
  loop:
    - "/opt/opengist"
    - "/var/lib/opengist"
    - "/etc/opengist"

- name: Fetch Opengist tarball
  get_url:
    url: "{{ opengist_url }}"
    dest: "{{ opengist_tarball }}"
    checksum: "sha256:{{ opengist_sha256 }}"

- name: Extract tarball
  unarchive:
    src: "{{ opengist_tarball }}"
    dest: "/opt/opengist"
    remote_src: true
    creates: "/opt/opengist/opengist"
    extra_opts:
      - --strip-components=1

- name: Create config.yml
  template:
    src: config.yml.j2
    dest: /etc/opengist/config.yml
    mode: "0644"

- name: Create s6 run script
  template:
    src: run.j2
    dest: /etc/services.d/opengist/run
    mode: "0755"

- name: Configure log service
  include_role:
    name: s6_log
  vars:
    s6_log_service_name: opengist

